<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RunwayReady - TOLD & Fuel Planning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 24px; }
        .input-field { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; background-color: white; }
        .label-text { display: block; font-size: 0.8rem; font-weight: 600; color: #4b5563; margin-bottom: 4px; text-transform: uppercase; }
        .v-val { font-family: 'JetBrains Mono', monospace; font-size: 1.875rem; font-weight: 700; color: #2563eb; }
        .bar-container { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.4s ease; }
        .tab-btn { padding: 4px 12px; font-weight: 600; font-size: 0.75rem; border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .told-title { font-weight: 900; letter-spacing: -0.05em; line-height: 1; }
        .to-color { color: #0ea5e9; }
        .ld-color { color: #92400e; }
        .fuel-color { color: #059669; }
        .thrust-toggle { display: flex; background: #f3f4f6; padding: 4px; border-radius: 8px; gap: 4px; }
        .thrust-option { flex: 1; text-align: center; padding: 8px 4px; font-size: 0.8rem; font-weight: 700; border-radius: 6px; cursor: pointer; color: #6b7280; }
        .thrust-option.active { background: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col lg:flex-row justify-between items-center mb-10 gap-4">
        <h1 class="told-title text-3xl md:text-5xl">
            <span class="to-color">TO</span><span class="ld-color">LD</span> <span class="fuel-color">& FUEL</span>
        </h1>
        
        <div class="flex flex-wrap items-center justify-center lg:justify-end gap-3 bg-white p-2 rounded-xl shadow-sm border border-gray-200 w-full lg:w-auto">
            <div class="flex border-r border-gray-100 pr-2">
                <button id="tab_airbus" class="tab-btn active" onclick="setManufacturer('Airbus')">Airbus</button>
                <button id="tab_boeing" class="tab-btn" onclick="setManufacturer('Boeing')">Boeing</button>
            </div>
            <select id="master_ac_type" class="bg-transparent font-bold text-gray-800 outline-none text-base md:text-lg cursor-pointer px-1 py-1" onchange="syncAircraft(this.value)"></select>
            <div id="engine_selector_container" class="hidden flex items-center px-2 border-l border-gray-200">
                <span class="text-[9px] font-extrabold text-gray-400 mr-2 bg-gray-100 px-1 rounded">ENG</span>
                <select id="master_engine_type" class="bg-transparent font-bold text-blue-600 outline-none text-xs md:text-sm cursor-pointer" onchange="calculateAll()"></select>
            </div>
            <div class="flex gap-1 p-1 bg-gray-50 rounded-lg">
                <button id="unit_tons" class="px-2 py-1 rounded-md text-[10px] font-bold shadow-sm bg-blue-600 text-white" onclick="setMasterUnit('tons')">METRIC</button>
                <button id="unit_lbs" class="px-2 py-1 rounded-md text-[10px] font-bold text-gray-500" onclick="setMasterUnit('lbs')">IMPERIAL</button>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- TAKEOFF -->
        <section class="card border-t-8 border-sky-500">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">üõ´</span>
                <h2 class="text-xl font-black text-sky-600 uppercase italic italic">Takeoff</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-full mb-2">
                    <label class="label-text">Ï∂îÎ†• ÏÑ§Ï†ï (Thrust)</label>
                    <div id="thrust_options_group" class="thrust-toggle"></div>
                </div>
                <div>
                    <label class="label-text">Ï§ëÎüâ (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="to_weight" class="input-field" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">CG (% MAC)</label>
                    <input type="number" id="to_cg" class="input-field" value="25.0" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">ÌôúÏ£ºÎ°ú Î∞©ÏúÑ (HDG)</label>
                    <input type="number" id="to_rwy_hdg" class="input-field" value="320" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Î∞îÎûå (Dir/Spd)</label>
                    <div class="flex gap-1">
                        <input type="number" id="to_wdir" class="input-field text-center p-1" value="320" oninput="calculateAll()">
                        <input type="number" id="to_wspd" class="input-field text-center p-1" value="10" oninput="calculateAll()">
                    </div>
                </div>
                <div>
                    <label class="label-text">ÌîåÎû© (Flaps)</label>
                    <select id="to_flaps" class="input-field" onchange="calculateAll()"></select>
                </div>
                <div>
                    <label class="label-text">TORA (m)</label>
                    <input type="number" id="to_tora" class="input-field" value="3000" oninput="calculateAll()">
                </div>
            </div>
            <div id="to_results" class="mt-8 p-6 bg-sky-50/50 rounded-xl border border-sky-100">
                <div class="flex justify-around mb-6 text-center">
                    <div><p class="label-text">V1</p><p id="res_v1" class="v-val">--</p></div>
                    <div><p class="label-text">VR</p><p id="res_vr" class="v-val">--</p></div>
                    <div><p class="label-text">V2</p><p id="res_v2" class="v-val">--</p></div>
                </div>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500 font-medium" id="flex_label">FLEX</span><span id="res_flex" class="font-bold text-sky-700">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">STAB TRIM</span><span id="res_trim" class="font-bold text-gray-800">--</span></div>
                </div>
                <div class="mt-4"><div class="bar-container"><div id="to_bar" class="bar-fill bg-sky-500"></div></div></div>
            </div>
            <p id="to_warn" class="hidden mt-3 p-2 bg-red-50 text-red-600 text-[10px] rounded border border-red-200 font-bold"></p>
        </section>

        <!-- LANDING -->
        <section class="card border-t-8 border-amber-800">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">üõ¨</span>
                <h2 class="text-xl font-black text-amber-800 uppercase italic">Landing</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-text">Ï§ëÎüâ (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="ld_weight" class="input-field" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">LDA (m)</label>
                    <input type="number" id="ld_lda" class="input-field" value="3000" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">ÌôúÏ£ºÎ°ú Î∞©ÏúÑ (HDG)</label>
                    <input type="number" id="ld_rwy_hdg" class="input-field" value="140" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Î∞îÎûå (Dir/Spd)</label>
                    <div class="flex gap-1">
                        <input type="number" id="ld_wdir" class="input-field text-center p-1" value="140" oninput="calculateAll()">
                        <input type="number" id="ld_wspd" class="input-field text-center p-1" value="10" oninput="calculateAll()">
                    </div>
                </div>
                <div>
                    <label class="label-text">ÌîåÎû© (Flaps)</label>
                    <select id="ld_flaps" class="input-field" onchange="calculateAll()"></select>
                </div>
                <div>
                    <label class="label-text">Ï†úÎèô (Braking)</label>
                    <select id="ld_brake" class="input-field" onchange="calculateAll()"></select>
                </div>
            </div>
            <div id="ld_results" class="mt-8 p-6 bg-amber-50/50 rounded-xl border border-amber-100">
                <div class="flex justify-around mb-6 text-center">
                    <div><p class="label-text">VREF</p><p id="res_vref" class="v-val text-amber-900">--</p></div>
                    <div><p class="label-text">VAPP</p><p id="res_vapp" class="v-val text-amber-900">--</p></div>
                </div>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">ÌïÑÏöî Í±∞Î¶¨</span><span id="res_fld" class="font-bold text-amber-950">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 font-medium">Ïó¨Ïú† Í±∞Î¶¨</span><span id="res_margin" class="font-bold text-gray-800">--</span></div>
                </div>
                <div class="mt-4"><div class="bar-container"><div id="ld_bar" class="bar-fill bg-amber-700"></div></div></div>
            </div>
            <p id="ld_warn" class="hidden mt-3 p-2 bg-red-50 text-red-600 text-[10px] rounded border border-red-200 font-bold"></p>
        </section>

        <!-- FUEL -->
        <section class="card border-t-8 border-emerald-600">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">‚õΩ</span>
                <h2 class="text-xl font-black text-emerald-600 uppercase italic">Fuel Plan</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label class="label-text">Í±∞Î¶¨ (NM)</label>
                    <input type="number" id="fuel_dist" class="input-field" value="500" step="10" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Cost Index</label>
                    <input type="number" id="fuel_ci" class="input-field" value="20" step="1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">ÌÉùÏã± Ïó∞Î£å (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="fuel_taxi" class="input-field" value="0.2" step="0.1" oninput="calculateAll()">
                </div>
                <div class="col-span-full">
                    <label class="label-text">Ï∞©Î•ô ÌõÑ ÏòàÎπÑ Ïó∞Î£å (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="fuel_reserve_input" class="input-field" value="3.5" step="0.1" oninput="calculateAll()">
                    <p class="text-[10px] text-gray-400 mt-1">ALTN/HOLD/FINAL RESV Ìè¨Ìï®</p>
                </div>
                <div class="col-span-full">
                    <label class="label-text">ÏòàÏÉÅ ÎπÑÌñâ ÏãúÍ∞Ñ</label>
                    <div id="res_time" class="p-3 bg-gray-50 rounded text-center font-bold mono">--:--</div>
                </div>
            </div>
            <div id="fuel_results" class="mt-8 p-6 bg-emerald-50/50 rounded-xl border border-emerald-100">
                <p class="label-text text-center">Ï¥ù ÌïÑÏöî Ïó∞Î£å (Block Fuel)</p>
                <p id="res_block" class="text-3xl font-black text-emerald-700 text-center mono mb-4">--</p>
                <div class="space-y-2 text-xs border-t border-emerald-100 pt-4">
                    <div class="flex justify-between"><span class="text-gray-500">TAXI</span><span id="res_taxi_out" class="font-bold">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">TRIP</span><span id="res_trip" class="font-bold">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">RESERVE (ALTN+)</span><span id="res_res" class="font-bold text-emerald-600">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500">CONTINGENCY (5%)</span><span id="res_extra" class="font-bold">--</span></div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    /**
     * PHYSICS & PERFORMANCE DATA MODEL
     */
    const K_LBS = 2.20462;
    const FLEET = {
        'A320-200': {
            mtow: 77.0, mlw: 66.0,
            toFlaps: [ {f:'1+F', k:1.0, o:0}, {f:'2', k:0.96, o:-2}, {f:'3', k:0.93, o:-4} ],
            ldFlaps: [ {f:'FULL', o:0, d:1.0}, {f:'3', o:5, d:1.08} ],
            ldBrakes: [ {n:'MAX', f:1.0}, {n:'MED', f:1.35}, {n:'LOW', f:1.85} ],
            vRefBase: 126, vScale: 1.65, trim: { n: 25, s: 0.12, l: 2.5 },
            burn: 2.4, speed: 450, reserve: 3.5, taxi: 0.2, engines: {
                'CFM56': { mtow: 0, v: 0, bfl: 1.0, flex: 70 },
                'IAE2500': { mtow: 0, v: 1, bfl: 1.0, flex: 68 }
            }
        },
        'A321-200': {
            mtow: 93.5, mlw: 77.8,
            toFlaps: [ {f:'1+F', k:1.0, o:0}, {f:'2', k:0.95, o:-2}, {f:'3', k:0.91, o:-5} ],
            ldFlaps: [ {f:'FULL', o:0, d:1.0}, {f:'3', o:6, d:1.1} ],
            ldBrakes: [ {n:'MAX', f:1.0}, {n:'MED', f:1.4}, {n:'LOW', f:1.95} ],
            vRefBase: 135, vScale: 1.45, trim: { n: 25, s: 0.14, l: 3.0 },
            burn: 2.8, speed: 445, reserve: 4.0, taxi: 0.3, engines: {
                'CFM56': { mtow: 0, v: 0, bfl: 1.0, flex: 65 },
                'IAE2500': { mtow: 0, v: 2, bfl: 0.98, flex: 62 }
            }
        },
        'A330-300': {
            mtow: 242.0, mlw: 187.0,
            toFlaps: [ {f:'1+F', k:1.0, o:0}, {f:'2', k:0.94, o:-3}, {f:'3', k:0.90, o:-6} ],
            ldFlaps: [ {f:'FULL', o:0, d:1.0}, {f:'3', o:4, d:1.05} ],
            ldBrakes: [ {n:'MAX', f:1.0}, {n:'MED', f:1.45}, {n:'LOW', f:2.1} ],
            vRefBase: 136, vScale: 0.42, trim: { n: 28, s: 0.18, l: 4.0 },
            burn: 5.8, speed: 480, reserve: 8.5, taxi: 0.6, engines: {
                'TRENT700': { mtow: 0, v: 0, bfl: 0.95, flex: 60 },
                'PW4000': { mtow: -1, v: 1, bfl: 1.0, flex: 58 }
            }
        },
        'B737-800': {
            mtow: 79.0, mlw: 66.3,
            toFlaps: [ {f:'1', k:1.0, o:0}, {f:'5', k:0.95, o:-3}, {f:'15', k:0.88, o:-7} ],
            ldFlaps: [ {f:'30', o:0, d:1.0}, {f:'40', o:-4, d:0.95} ],
            ldBrakes: [ {n:'MAX', f:1.0}, {n:'3', f:1.35}, {n:'2', f:1.7}, {n:'1', f:2.3} ],
            vRefBase: 130, vScale: 1.75, trim: { b: 5.2, ws: 0.05, cs: 0.15 },
            burn: 2.3, speed: 445, reserve: 3.2, taxi: 0.2, engines: {
                'CFM56-7B': { mtow: 0, v: 0, bfl: 1.0, flex: 70 }
            }
        }
    };

    let curUnit = 'tons';
    let curMfr = 'Airbus';
    let curMode = 'FLEX';

    /**
     * UI CONTROLLERS
     */
    function setManufacturer(mfr) {
        curMfr = mfr;
        document.getElementById('tab_airbus').classList.toggle('active', mfr === 'Airbus');
        document.getElementById('tab_boeing').classList.toggle('active', mfr === 'Boeing');
        
        const sel = document.getElementById('master_ac_type');
        sel.innerHTML = '';
        Object.keys(FLEET).filter(k => k.startsWith(mfr === 'Airbus' ? 'A' : 'B')).forEach(k => {
            const opt = document.createElement('option');
            opt.value = k; opt.innerText = k; sel.appendChild(opt);
        });
        curMode = mfr === 'Airbus' ? 'FLEX' : 'TO';
        renderThrustUI();
        syncAircraft(sel.value);
    }

    function renderThrustUI() {
        const g = document.getElementById('thrust_options_group');
        g.innerHTML = '';
        const modes = curMfr === 'Airbus' ? ['FLEX', 'TOGA'] : ['TO', 'TO-1', 'TO-2'];
        modes.forEach(m => {
            const d = document.createElement('div');
            d.className = `thrust-option ${curMode === m ? 'active' : ''}`;
            d.innerText = m;
            d.onclick = () => { curMode = m; renderThrustUI(); calculateAll(); };
            g.appendChild(d);
        });
    }

    function syncAircraft(val) {
        const ac = FLEET[val];
        if(!ac) return;

        const es = document.getElementById('master_engine_type');
        es.innerHTML = '';
        Object.keys(ac.engines).forEach(k => {
            const opt = document.createElement('option'); opt.value = k; opt.innerText = k; es.appendChild(opt);
        });
        document.getElementById('engine_selector_container').classList.toggle('hidden', Object.keys(ac.engines).length < 2);

        // Unit Conversion for initial values
        const factor = curUnit === 'lbs' ? K_LBS : 1;
        document.getElementById('to_weight').value = (ac.mtow * 0.9 * factor).toFixed(1);
        document.getElementById('ld_weight').value = (ac.mlw * 0.9 * factor).toFixed(1);
        document.getElementById('fuel_reserve_input').value = (ac.reserve * factor).toFixed(1);
        document.getElementById('fuel_taxi').value = (ac.taxi * factor).toFixed(1);

        // Flaps & Brakes
        const tf = document.getElementById('to_flaps'); tf.innerHTML = '';
        ac.toFlaps.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.innerText = f.f; tf.appendChild(o); });
        const lf = document.getElementById('ld_flaps'); lf.innerHTML = '';
        ac.ldFlaps.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.innerText = f.f; lf.appendChild(o); });
        const lb = document.getElementById('ld_brake'); lb.innerHTML = '';
        ac.ldBrakes.forEach((b, i) => { const o = document.createElement('option'); o.value = b.f; o.innerText = b.n; lb.appendChild(o); });

        calculateAll();
    }

    function setMasterUnit(u) {
        if(curUnit === u) return;
        const factor = u === 'lbs' ? K_LBS : (1/K_LBS);
        ['to_weight', 'ld_weight', 'fuel_reserve_input', 'fuel_taxi'].forEach(id => {
            const el = document.getElementById(id);
            el.value = (parseFloat(el.value) * factor).toFixed(1);
        });
        document.querySelectorAll('.unit-text').forEach(t => t.innerText = u === 'lbs' ? 'Lbs' : 'Tons');
        document.getElementById('unit_tons').className = u === 'tons' ? "px-2 py-1 rounded-md text-[10px] font-bold shadow-sm bg-blue-600 text-white" : "px-2 py-1 rounded-md text-[10px] font-bold text-gray-500";
        document.getElementById('unit_lbs').className = u === 'lbs' ? "px-2 py-1 rounded-md text-[10px] font-bold shadow-sm bg-blue-600 text-white" : "px-2 py-1 rounded-md text-[10px] font-bold text-gray-500";
        curUnit = u;
        calculateAll();
    }

    /**
     * CORE CALCULATION ENGINES
     */
    function calculateAll() {
        const acId = document.getElementById('master_ac_type').value;
        const ac = FLEET[acId];
        if(!ac) return;

        const engId = document.getElementById('master_engine_type').value;
        const eng = ac.engines[engId] || { mtow:0, v:0, bfl:1.0, flex:70 };

        calculateTakeoff(ac, eng);
        calculateLanding(ac);
        calculateFuel(ac);
    }

    function calculateTakeoff(ac, eng) {
        const w_raw = parseFloat(document.getElementById('to_weight').value);
        const w = curUnit === 'lbs' ? w_raw / K_LBS : w_raw;
        const tora = parseFloat(document.getElementById('to_tora').value);
        const cg = parseFloat(document.getElementById('to_cg').value);
        const flapIdx = document.getElementById('to_flaps').value;
        const flap = ac.toFlaps[flapIdx];
        
        const mtow = ac.mtow + eng.mtow;
        const warn = document.getElementById('to_warn');
        const resDiv = document.getElementById('to_results');

        if(w > mtow + 0.1 || w < 30) {
            warn.innerText = `‚ö†Ô∏è Ï§ëÎüâ Ï†úÌïú Ï¥àÍ≥º (MTOW ${mtow}T)`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30'); return;
        }

        const weightRef = mtow > 150 ? (mtow * 0.7) : 58;
        let v2 = (ac.vRefBase + (w - weightRef) * ac.vScale) + flap.o + eng.v;
        let vr = v2 - (mtow > 150 ? 5 : 4);
        let v1 = vr - (curMode === 'TOGA' || curMode === 'TO' ? 2 : 4);

        const wind = calcWindComp('to_wdir', 'to_wspd', 'to_rwy_hdg');
        const windFact = wind >= 0 ? 1 - (wind * 0.007) : 1 + (Math.abs(wind) * 0.02);
        const tFact = curMode.includes('1') || curMode === 'FLEX' ? 1.12 : (curMode.includes('2') ? 1.25 : 0.95);
        const bfl = (mtow > 150 ? 1850 : 1550) * Math.pow(w/(mtow*0.82), 2.1) * eng.bfl * tFact * windFact * flap.k;

        if(bfl > tora) {
            warn.innerText = `‚ö†Ô∏è ÌôúÏ£ºÎ°ú Í∏∏Ïù¥ Î∂ÄÏ°± (${Math.round(bfl)}m ÌïÑÏöî)`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30'); return;
        }

        warn.classList.add('hidden'); resDiv.classList.remove('opacity-30');
        document.getElementById('res_v1').innerText = Math.round(v1);
        document.getElementById('res_vr').innerText = Math.round(vr);
        document.getElementById('res_v2').innerText = Math.round(v2);
        document.getElementById('to_bar').style.width = Math.min((bfl/tora)*100, 100) + '%';
        
        if(curMfr === 'Airbus') {
            let ths = (ac.trim.n - cg) * ac.trim.s;
            ths = Math.min(Math.max(ths, -ac.trim.l), ac.trim.l);
            document.getElementById('res_trim').innerText = (ths >= 0 ? 'UP ' : 'DN ') + Math.abs(ths).toFixed(1);
            document.getElementById('res_flex').innerText = curMode === 'FLEX' ? `+${Math.min(Math.max(42, 68 - Math.floor(w/8)), eng.flex)}¬∞C` : 'TOGA';
            document.getElementById('flex_label').innerText = 'FLEX';
        } else {
            let stab = ac.trim.b + ((w/mtow)*ac.trim.ws*10) - ((cg-20)*ac.trim.cs);
            document.getElementById('res_trim').innerText = stab.toFixed(1);
            document.getElementById('res_flex').innerText = curMode;
            document.getElementById('flex_label').innerText = 'RATING';
        }
    }

    function calculateLanding(ac) {
        const w_raw = parseFloat(document.getElementById('ld_weight').value);
        const w = curUnit === 'lbs' ? w_raw / K_LBS : w_raw;
        const lda = parseFloat(document.getElementById('ld_lda').value);
        const flapIdx = document.getElementById('ld_flaps').value;
        const flap = ac.ldFlaps[flapIdx];
        const brake = parseFloat(document.getElementById('ld_brake').value);

        const warn = document.getElementById('ld_warn');
        const resDiv = document.getElementById('ld_results');

        if(w > ac.mlw + 0.1 || w < 30) {
            warn.innerText = `‚ö†Ô∏è Ï∞©Î•ô Ï§ëÎüâ Ï¥àÍ≥º (MLW ${ac.mlw}T)`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30'); return;
        }

        const vref = (ac.vRefBase - 5 + (w - (ac.mlw*0.75)) * ac.vScale) + flap.o;
        const wind = calcWindComp('ld_wdir', 'ld_wspd', 'ld_rwy_hdg');
        const vapp = vref + (wind > 0 ? Math.max(5, Math.min(15, wind/2)) : 5);

        const windFact = wind >= 0 ? 1 - (wind * 0.012) : 1 + (Math.abs(wind) * 0.03);
        const fld = (ac.mtow > 150 ? 1750 : 1250) * Math.pow(w/ac.mlw, 1.8) * brake * 1.67 * windFact * flap.d;

        if(fld > lda) {
            warn.innerText = `‚ö†Ô∏è ÌôúÏ£ºÎ°ú Ï¥àÍ≥º ÏúÑÌóò (${Math.round(fld)}m ÌïÑÏöî)`;
            warn.classList.remove('hidden'); resDiv.classList.add('opacity-30'); return;
        }

        warn.classList.add('hidden'); resDiv.classList.remove('opacity-30');
        document.getElementById('res_vref').innerText = Math.round(vref);
        document.getElementById('res_vapp').innerText = Math.round(vapp);
        document.getElementById('res_fld').innerText = Math.round(fld) + ' m';
        document.getElementById('res_margin').innerText = Math.round(lda - fld) + ' m';
        document.getElementById('ld_bar').style.width = Math.min((fld/lda)*100, 100) + '%';
    }

    function calculateFuel(ac) {
        const dist = parseFloat(document.getElementById('fuel_dist').value) || 0;
        const ci = parseFloat(document.getElementById('fuel_ci').value) || 0;
        const inputTaxi = parseFloat(document.getElementById('fuel_taxi').value) || 0;
        const inputReserve = parseFloat(document.getElementById('fuel_reserve_input').value) || 0;

        const f = curUnit === 'lbs' ? K_LBS : 1;
        const invF = 1/f;

        const speed = ac.speed + (ci * 0.1);
        const time = dist / speed;
        
        // Internal calculations always in Metric (Tons)
        const burnMetric = ac.burn * (1 + (ci/1000)) * time;
        const taxiMetric = inputTaxi * invF;
        const reserveMetric = inputReserve * invF;
        
        const extraMetric = (burnMetric * 0.05); // Contingency 5%
        const blockMetric = taxiMetric + burnMetric + reserveMetric + extraMetric;

        const h = Math.floor(time);
        const m = Math.floor((time - h) * 60);
        
        document.getElementById('res_time').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        document.getElementById('res_block').innerText = (blockMetric * f).toFixed(1) + (curUnit === 'lbs' ? ' LBS' : ' T');
        
        document.getElementById('res_taxi_out').innerText = (taxiMetric * f).toFixed(1);
        document.getElementById('res_trip').innerText = (burnMetric * f).toFixed(1);
        document.getElementById('res_res').innerText = (reserveMetric * f).toFixed(1);
        document.getElementById('res_extra').innerText = (extraMetric * f).toFixed(1);
    }

    function calcWindComp(wdirId, wspdId, rhdgId) {
        const d = parseFloat(document.getElementById(wdirId).value);
        const s = parseFloat(document.getElementById(wspdId).value);
        const h = parseFloat(document.getElementById(rhdgId).value);
        return s * Math.cos((d - h) * Math.PI / 180);
    }

    window.onload = () => setManufacturer('Airbus');
</script>
</body>
</html>
