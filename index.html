<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choco Aviation - Flight Deck Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f3f4f6;
            --bg-card: white;
            --text-main: #1f2937;
            --text-label: #4b5563;
            --border-color: #d1d5db;
            --input-bg: white;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --res-bg: rgba(240, 249, 255, 0.5);
        }

        .dark-mode {
            --bg-main: #0b0f19;
            --bg-card: #161e2e;
            --text-main: #f3f4f6;
            --text-label: #9ca3af;
            --border-color: #2d3748;
            --input-bg: #0b0f19;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6);
            --res-bg: rgba(30, 41, 59, 0.5);
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-main); transition: background 0.3s ease, color 0.3s ease; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .card { background: var(--bg-card); border-radius: 12px; box-shadow: var(--card-shadow); padding: 24px; transition: background 0.3s ease, border-color 0.3s ease; }
        .input-field { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.95rem; background-color: var(--input-bg); color: var(--text-main); outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #3b82f6; }
        .label-text { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-label); margin-bottom: 4px; text-transform: uppercase; }
        .v-val { font-family: 'JetBrains Mono', monospace; font-size: 1.875rem; font-weight: 700; color: #2563eb; }
        .dark-mode .v-val { color: #60a5fa; }
        .bar-container { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; position: relative; }
        .dark-mode .bar-container { background: #374151; }
        .bar-fill { height: 100%; transition: width 0.4s ease; position: absolute; left: 0; top: 0; }
        .tab-btn { padding: 4px 12px; font-weight: 600; font-size: 0.75rem; border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-btn.active { border-bottom-color: #2563eb; color: #2563eb; }
        .dark-mode .tab-btn.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .told-title { font-weight: 900; letter-spacing: -0.05em; line-height: 1; }
        .thrust-toggle { display: flex; background: #f3f4f6; padding: 4px; border-radius: 8px; gap: 4px; }
        .dark-mode .thrust-toggle { background: #0b0f19; }
        .thrust-option { flex: 1; text-align: center; padding: 8px 4px; font-size: 0.8rem; font-weight: 700; border-radius: 6px; cursor: pointer; color: #6b7280; }
        .thrust-option.active { background: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dark-mode .thrust-option.active { background: #374151; color: #60a5fa; }
        .env-mini-grid { display: grid; grid-template-cols: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 8px; border: 1px solid var(--border-color); }
        .dark-mode .env-mini-grid { background: rgba(255,255,255,0.02); }
        
        /* Knobs */
        .knob-container { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .knob { width: 40px; height: 40px; background: #374151; border-radius: 50%; position: relative; cursor: pointer; border: 3px solid #1f2937; box-shadow: inset 0 2px 4px rgba(255,255,255,0.1); transition: transform 0.3s ease; }
        .knob::after { content: ''; position: absolute; top: 4px; left: 50%; width: 4px; height: 12px; background: #ef4444; transform: translateX(-50%); border-radius: 2px; }
        .knob.on { transform: rotate(180deg); }
        .knob.blue::after { background: #3b82f6; }

        .wind-group { display: flex; gap: 2px; background: var(--border-color); padding: 1px; border-radius: 6px; overflow: hidden; }
        .wind-input { border: none !important; border-radius: 0 !important; text-align: center; padding: 10px 4px !important; font-size: 0.75rem !important; }

        #route_finder_modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); display: none; align-items: center; 
            justify-content: center; z-index: 100; backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-7xl mx-auto">
    <header class="flex flex-col lg:flex-row justify-between items-center mb-10 gap-4">
        <div class="flex flex-col">
            <h1 class="told-title text-3xl md:text-5xl">
                <span class="text-amber-900">CHOCO</span> <span class="dark:text-white">AVIATION</span>
            </h1>
        </div>
        
        <div class="flex wrap items-center justify-center lg:justify-end gap-3 bg-white dark:bg-gray-800 p-2 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 w-full lg:w-auto">
            <div class="flex border-r border-gray-100 dark:border-gray-700 pr-2">
                <button id="tab_airbus" class="tab-btn active" onclick="setManufacturer('Airbus')">Airbus</button>
                <button id="tab_boeing" class="tab-btn" onclick="setManufacturer('Boeing')">Boeing</button>
            </div>
            <select id="master_ac_type" class="bg-transparent font-bold text-gray-800 dark:text-gray-100 outline-none text-base md:text-lg cursor-pointer px-1 py-1" onchange="syncAircraft(this.value)"></select>
            <div id="engine_selector_container" class="hidden flex items-center px-2 border-l border-gray-200 dark:border-gray-700">
                <span class="text-[9px] font-extrabold text-gray-400 mr-2 bg-gray-100 dark:bg-gray-700 px-1 rounded uppercase">Eng Spec</span>
                <select id="master_engine_type" class="bg-transparent font-bold text-blue-600 outline-none text-xs md:text-sm cursor-pointer" onchange="calculateAll()"></select>
            </div>
            <div class="flex gap-1 p-1 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <button id="unit_tons" class="px-2 py-1 rounded-md text-[10px] font-bold shadow-sm bg-blue-600 text-white" onclick="setMasterUnit('tons')">METRIC</button>
                <button id="unit_lbs" class="px-2 py-1 rounded-md text-[10px] font-bold text-gray-500" onclick="setMasterUnit('lbs')">IMPERIAL</button>
            </div>
            
            <div class="flex gap-4 border-l border-gray-200 dark:border-gray-700 pl-4">
                <div class="knob-container">
                    <div id="route_knob" class="knob blue" onclick="toggleRouteFinder()"></div>
                    <span class="text-[8px] font-black text-blue-500 uppercase">Route Finder</span>
                </div>
                <div class="knob-container">
                    <div id="dome_knob" class="knob" onclick="toggleDarkMode()"></div>
                    <span class="text-[8px] font-black text-gray-400 dark:text-gray-500 uppercase">Dome Light</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Route Finder Modal -->
    <div id="route_finder_modal">
        <div class="bg-white dark:bg-gray-800 w-full max-w-lg p-6 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 mx-4">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <h3 class="text-xl font-black italic uppercase text-blue-600 dark:text-blue-400 leading-none">Route Finder</h3>
                    <span class="bg-blue-600 text-white text-[9px] font-black px-1.5 py-0.5 rounded italic">BETA</span>
                </div>
                <button onclick="toggleRouteFinder()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-2xl">‚úï</button>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="label-text">Departure (Origin)</label>
                    <select id="route_origin" class="input-field font-bold">
                        <option value="RKSI">RKSI (Seoul/Incheon)</option>
                        <option value="RKSS">RKSS (Seoul/Gimpo)</option>
                        <option value="KJFK">KJFK (New York JFK)</option>
                        <option value="EGLL">EGLL (London Heathrow)</option>
                        <option value="RJAA">RJAA (Tokyo Narita)</option>
                    </select>
                </div>
                <div>
                    <label class="label-text">Service Type</label>
                    <select id="route_type" class="input-field font-bold">
                        <option value="ALL">All Destinations</option>
                        <option value="DOM">Domestic</option>
                        <option value="INT">International</option>
                    </select>
                </div>
            </div>
            <button onclick="generateRecommendation()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black uppercase tracking-widest hover:bg-blue-700 transition shadow-lg shadow-blue-500/30 mb-6">Search Realistic Routes</button>
            <div id="route_results" class="space-y-3 max-h-80 overflow-y-auto pr-2 hidden"></div>
            <div id="route_empty" class="text-center py-10 text-gray-400 italic text-sm">Select origin and search for real destinations.</div>
        </div>
    </div>

    <!-- ... rest of the grid sections (Takeoff, Landing, Fuel) ... -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Takeoff Section -->
        <section class="card border-t-8 border-sky-500">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üõ´</span>
                    <h2 class="text-xl font-black text-sky-600 dark:text-sky-400 uppercase italic">Takeoff</h2>
                </div>
                <span id="to_perf_label" class="text-[10px] font-bold px-2 py-1 bg-sky-100 dark:bg-sky-900/40 text-sky-700 dark:text-sky-300 rounded-full">NORMAL</span>
            </div>
            
            <div class="env-mini-grid">
                <div>
                    <label class="label-text">OAT (¬∞C)</label>
                    <input type="number" id="to_env_oat" class="input-field text-xs font-bold" value="15" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">ELEV (ft)</label>
                    <input type="number" id="to_env_elev" class="input-field text-xs font-bold" value="0" step="100" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">QNH (hPa)</label>
                    <input type="number" id="to_env_qnh" class="input-field text-xs font-bold" value="1013" min="800" max="1100" oninput="calculateAll()">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="col-span-full">
                    <label class="label-text">Thrust Setting</label>
                    <div id="thrust_options_group" class="thrust-toggle"></div>
                </div>
                <div>
                    <label class="label-text">Runway Cond</label>
                    <select id="to_rwy_cond" class="input-field font-bold text-blue-700 dark:text-blue-400" onchange="calculateAll()">
                        <option value="dry">DRY</option>
                        <option value="wet">WET</option>
                        <option value="contaminated">ICE/SNOW</option>
                    </select>
                </div>
                <div>
                    <label class="label-text">Slope (%)</label>
                    <input type="number" id="to_slope" class="input-field font-bold" value="0" step="0.1" min="-2" max="2" oninput="validateRange(this, -2, 2); calculateAll()">
                </div>
                <div>
                    <label class="label-text">Weight (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="to_weight" class="input-field" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">CG (% MAC)</label>
                    <input type="number" id="to_cg" class="input-field" value="25.0" step="0.1" max="50" oninput="validateRange(this, 0, 50); calculateAll()">
                </div>
                <div class="col-span-full">
                    <label class="label-text">RWY HDG / WIND / SPEED</label>
                    <div class="wind-group">
                        <input type="number" id="to_rwy_hdg" class="input-field wind-input w-1/3" placeholder="HDG" value="320" min="0" max="360" oninput="calculateAll()">
                        <input type="number" id="to_wdir" class="input-field wind-input w-1/3" placeholder="WIND" value="320" min="0" max="360" oninput="calculateAll()">
                        <input type="number" id="to_wspd" class="input-field wind-input w-1/3" placeholder="KT" value="10" min="0" max="99" oninput="calculateAll()">
                    </div>
                </div>
                <div>
                    <label class="label-text">Flaps</label>
                    <select id="to_flaps" class="input-field" onchange="calculateAll()"></select>
                </div>
                <div>
                    <label class="label-text">TORA (m)</label>
                    <input type="number" id="to_tora" class="input-field font-bold" value="3000" min="500" oninput="calculateAll()">
                </div>
            </div>
            
            <div id="to_results" class="mt-8 p-6 bg-sky-50/50 dark:bg-slate-800/50 rounded-xl border border-sky-100 dark:border-sky-900">
                <div class="flex justify-around mb-6 text-center">
                    <div><p class="label-text">V1</p><p id="res_v1" class="v-val">--</p></div>
                    <div><p class="label-text">VR</p><p id="res_vr" class="v-val">--</p></div>
                    <div><p class="label-text">V2</p><p id="res_v2" class="v-val">--</p></div>
                </div>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400 font-medium">REQ TO DIST</span><span id="res_dist" class="font-bold text-sky-700 dark:text-sky-400">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400 font-medium" id="flex_label">THRUST</span><span id="res_flex" class="font-bold text-sky-700 dark:text-sky-400">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400 font-medium">STAB TRIM</span><span id="res_trim" class="font-bold text-gray-800 dark:text-gray-100">--</span></div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between text-[8px] font-bold text-gray-400 mb-1"><span>0m</span><span>RUNWAY UTILIZATION</span><span id="to_dist_pct">0%</span></div>
                    <div class="bar-container"><div id="to_bar" class="bar-fill bg-sky-500"></div></div>
                </div>
            </div>
            <p id="to_warn" class="hidden mt-3 p-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-[10px] rounded border border-red-200 dark:border-red-800 font-bold"></p>
        </section>

        <!-- Landing Section -->
        <section class="card border-t-8 border-amber-800">
            <div class="flex items-center gap-2 mb-4">
                <span class="text-2xl">üõ¨</span>
                <h2 class="text-xl font-black text-amber-800 dark:text-amber-600 uppercase italic">Landing</h2>
            </div>
            <div class="env-mini-grid">
                <div>
                    <label class="label-text">OAT (¬∞C)</label>
                    <input type="number" id="ld_env_oat" class="input-field text-xs font-bold" value="15" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">ELEV (ft)</label>
                    <input type="number" id="ld_env_elev" class="input-field text-xs font-bold" value="0" step="100" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">QNH (hPa)</label>
                    <input type="number" id="ld_env_qnh" class="input-field text-xs font-bold" value="1013" min="800" max="1100" oninput="calculateAll()">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-text">Weight (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="ld_weight" class="input-field" step="0.1" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Slope (%)</label>
                    <input type="number" id="ld_slope" class="input-field font-bold" value="0" step="0.1" min="-2" max="2" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">LDA (m)</label>
                    <input type="number" id="ld_lda" class="input-field font-bold" value="3000" min="500" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Flaps</label>
                    <select id="ld_flaps" class="input-field" onchange="calculateAll()"></select>
                </div>
                <div class="col-span-full">
                    <label class="label-text">RWY HDG / WIND / SPEED</label>
                    <div class="wind-group">
                        <input type="number" id="ld_rwy_hdg" class="input-field wind-input w-1/3" placeholder="HDG" value="140" min="0" max="360" oninput="calculateAll()">
                        <input type="number" id="ld_wdir" class="input-field wind-input w-1/3" placeholder="WIND" value="140" min="0" max="360" oninput="calculateAll()">
                        <input type="number" id="ld_wspd" class="input-field wind-input w-1/3" placeholder="KT" value="10" min="0" max="99" oninput="calculateAll()">
                    </div>
                </div>
                <div class="col-span-full">
                    <label class="label-text">Braking Action</label>
                    <select id="ld_brake" class="input-field" onchange="calculateAll()"></select>
                </div>
            </div>
            <div id="ld_results" class="mt-8 p-6 bg-amber-50/50 dark:bg-slate-800/50 rounded-xl border border-amber-100 dark:border-amber-900">
                <div class="flex justify-around mb-6 text-center">
                    <div><p class="label-text">VREF</p><p id="res_vref" class="v-val text-amber-900 dark:text-amber-500">--</p></div>
                    <div><p class="label-text">VAPP</p><p id="res_vapp" class="v-val text-amber-900 dark:text-amber-500">--</p></div>
                </div>
                <div class="space-y-3 text-xs">
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400 font-medium">Factored LD</span><span id="res_fld" class="font-bold text-amber-950 dark:text-amber-100">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400 font-medium">Margin</span><span id="res_margin" class="font-bold text-gray-800 dark:text-gray-100">--</span></div>
                </div>
                <div class="mt-4"><div class="bar-container"><div id="ld_bar" class="bar-fill bg-amber-700"></div></div></div>
            </div>
            <p id="ld_warn" class="hidden mt-3 p-2 bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-[10px] rounded border border-red-200 dark:border-red-800 font-bold"></p>
        </section>

        <!-- Fuel Plan Section -->
        <section class="card border-t-8 border-emerald-600">
            <div class="flex items-center gap-2 mb-6">
                <span class="text-2xl">‚õΩ</span>
                <h2 class="text-xl font-black text-emerald-600 dark:text-emerald-400 uppercase italic">Fuel Plan</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="label-text">Distance (NM)</label>
                    <input type="number" id="fuel_dist" class="input-field" value="500" step="10" min="0" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Cruise FL</label>
                    <input type="number" id="fuel_fl" class="input-field font-bold text-emerald-600 dark:text-emerald-400" value="350" step="10" min="0" max="450" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Avg. Winds (kt)</label>
                    <input type="number" id="fuel_wind" class="input-field" value="0" step="5" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Cost Index</label>
                    <input type="number" id="fuel_ci" class="input-field" value="20" step="1" min="0" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Taxi (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="fuel_taxi" class="input-field" value="0.2" step="0.1" min="0" oninput="calculateAll()">
                </div>
                <div>
                    <label class="label-text">Reserve (<span class="unit-text">Tons</span>)</label>
                    <input type="number" id="fuel_reserve_input" class="input-field" value="3.5" step="0.1" min="0" oninput="calculateAll()">
                </div>
            </div>
            <div id="fuel_results" class="mt-8 p-6 bg-emerald-50/50 dark:bg-slate-800/50 rounded-xl border border-emerald-100 dark:border-emerald-900">
                <p class="label-text text-center">Total Block Fuel</p>
                <p id="res_block" class="text-3xl font-black text-emerald-700 dark:text-emerald-400 text-center mono mb-4">--</p>
                <div class="space-y-2 text-xs border-t border-emerald-100 dark:border-emerald-900 pt-4">
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">ETE (GS ADJ)</span><span id="res_time" class="font-bold dark:text-gray-100">--:--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">TRIP + CONT (5%)</span><span id="res_trip" class="font-bold dark:text-gray-100">--</span></div>
                    <div class="flex justify-between"><span class="text-gray-500 dark:text-gray-400">EFFICIENCY (FL)</span><span id="res_eff" class="font-bold text-emerald-600 dark:text-emerald-400">--</span></div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    const K_LBS = 2.20462;
    const KT_TO_MS = 0.514444; 
    const MS_TO_KT = 1.94384;
    const G_ACCEL = 9.80665;   
    const FT_TO_M = 0.3048;
    const R_DRY_AIR = 287.058; 

    const FLEET = {
        'A320-200': {
            mtow: 77.0, mlw: 66.0, oew: 42.6, burnRate: 2.35, cruiseSpeed: 450, climbFuel: 0.45, maxRange: 3300,
            toFlaps: [ {f:'1+F', cl_to: 1.45, cl_max: 2.10, cd0: 0.035}, {f:'2', cl_to: 1.65, cl_max: 2.35, cd0: 0.045}, {f:'3', cl_to: 1.80, cl_max: 2.50, cd0: 0.055} ],
            ldFlaps: [ {f:'FULL', cl_ref: 2.65, d: 1.0}, {f:'3', cl_ref: 2.35, d: 1.15} ],
            ldBrakes: [ {n:'MAX', decel: 4.8}, {n:'MED', decel: 3.0}, {n:'LOW', decel: 1.7} ],
            vRefBase: 132, trim_type: 'THS', s_area: 122.6, 
            engines: { 'CFM56-5B4 (27K)': { thrust_kn: 120, flat_rating: 30 }, 'IAE V2527 (27K)': { thrust_kn: 118, flat_rating: 30 } }
        },
        'A321-200': {
            mtow: 93.5, mlw: 77.8, oew: 48.5, burnRate: 2.75, cruiseSpeed: 455, climbFuel: 0.55, maxRange: 3200,
            toFlaps: [ {f:'1+F', cl_to: 1.40, cl_max: 2.05, cd0: 0.038}, {f:'2', cl_to: 1.60, cl_max: 2.30, cd0: 0.048}, {f:'3', cl_to: 1.75, cl_max: 2.45, cd0: 0.058} ],
            ldFlaps: [ {f:'FULL', cl_ref: 2.60, d: 1.0}, {f:'3', cl_ref: 2.30, d: 1.18} ],
            ldBrakes: [ {n:'MAX', decel: 4.5}, {n:'MED', decel: 2.8}, {n:'LOW', decel: 1.6} ],
            vRefBase: 142, trim_type: 'THS', s_area: 126.0,
            engines: { 'CFM56-5B3': { thrust_kn: 142, flat_rating: 30 }, 'IAE V2533': { thrust_kn: 146, flat_rating: 30 } }
        },
        'B737-800': {
            mtow: 79.0, mlw: 66.3, oew: 41.4, burnRate: 2.45, cruiseSpeed: 450, climbFuel: 0.45, maxRange: 2930,
            toFlaps: [ {f:'1', cl_to: 1.35, cl_max: 1.95, cd0: 0.032}, {f:'5', cl_to: 1.55, cl_max: 2.20, cd0: 0.042}, {f:'15', cl_to: 1.75, cl_max: 2.40, cd0: 0.052} ],
            ldFlaps: [ {f:'30', cl_ref: 2.50, d: 1.0}, {f:'40', cl_ref: 2.70, d: 0.95} ],
            ldBrakes: [ {n:'MAX', decel: 5.2}, {n:'3', decel: 3.8}, {n:'2', decel: 2.5}, {n:'1', decel: 1.4} ],
            vRefBase: 140, trim_type: 'ANU', s_area: 124.6,
            engines: { 'CFM56-7B26 (26K)': { thrust_kn: 117, flat_rating: 30 } }
        },
        'B777-300ER': {
            mtow: 351.5, mlw: 251.2, oew: 167.8, burnRate: 8.4, cruiseSpeed: 495, climbFuel: 3.5, maxRange: 7370,
            toFlaps: [ {f:'5', cl_to: 1.30, cl_max: 1.85, cd0: 0.030}, {f:'15', cl_to: 1.50, cl_max: 2.10, cd0: 0.040}, {f:'20', cl_to: 1.65, cl_max: 2.25, cd0: 0.050} ],
            ldFlaps: [ {f:'30', cl_ref: 2.55, d: 1.0}, {f:'25', cl_ref: 2.30, d: 1.15} ],
            ldBrakes: [ {n:'MAX', decel: 4.8}, {n:'4', decel: 3.9}, {n:'3', decel: 2.9}, {n:'2', decel: 1.9}, {n:'1', decel: 1.1} ],
            vRefBase: 145, trim_type: 'ANU', s_area: 436.8,
            engines: { 'GE90-115B': { thrust_kn: 512, flat_rating: 32 } }
        }
    };

    const REAL_ROUTES = {
        'RKSI': [
            { icao: 'KJFK', name: 'New York (JFK)', dist: 6050, type: 'INT' },
            { icao: 'EGLL', name: 'London (Heathrow)', dist: 4800, type: 'INT' },
            { icao: 'RJAA', name: 'Tokyo (Narita)', dist: 680, type: 'INT' },
            { icao: 'RJBB', name: 'Osaka (Kansai)', dist: 465, type: 'INT' },
            { icao: 'WSSS', name: 'Singapore (Changi)', dist: 2500, type: 'INT' },
            { icao: 'VHHH', name: 'Hong Kong', dist: 1120, type: 'INT' },
            { icao: 'KLAX', name: 'Los Angeles', dist: 5180, type: 'INT' },
            { icao: 'RKPK', name: 'Busan', dist: 180, type: 'DOM' }, 
            { icao: 'RKTN', name: 'Daegu', dist: 145, type: 'DOM' }, 
        ],
        'RKSS': [
            { icao: 'RKPC', name: 'Jeju', dist: 243, type: 'DOM' },
            { icao: 'RKPK', name: 'Busan', dist: 180, type: 'DOM' },
            { icao: 'RJTT', name: 'Tokyo (Haneda)', dist: 630, type: 'INT' },
            { icao: 'RJBB', name: 'Osaka (Kansai)', dist: 465, type: 'INT' },
            { icao: 'ZSPD', name: 'Shanghai (Pudong)', dist: 450, type: 'INT' },
        ],
        'KJFK': [
            { icao: 'RKSI', name: 'Seoul (Incheon)', dist: 6050, type: 'INT' },
            { icao: 'EGLL', name: 'London (Heathrow)', dist: 3000, type: 'INT' },
            { icao: 'KLAX', name: 'Los Angeles', dist: 2470, type: 'DOM' },
            { icao: 'LFPG', name: 'Paris (CDG)', dist: 3150, type: 'INT' },
        ],
        'EGLL': [
            { icao: 'RKSI', name: 'Seoul (Incheon)', dist: 4800, type: 'INT' },
            { icao: 'KJFK', name: 'New York (JFK)', dist: 3000, type: 'INT' },
            { icao: 'LFPG', name: 'Paris (CDG)', dist: 215, type: 'INT' },
            { icao: 'OMDB', name: 'Dubai', dist: 2970, type: 'INT' },
        ],
        'RJAA': [
            { icao: 'RKSI', name: 'Seoul (Incheon)', dist: 680, type: 'INT' },
            { icao: 'KJFK', name: 'New York (JFK)', dist: 5850, type: 'INT' },
            { icao: 'PHNL', name: 'Honolulu', dist: 3320, type: 'INT' },
            { icao: 'WSSS', name: 'Singapore (Changi)', dist: 2900, type: 'INT' },
        ]
    };

    let curUnit = 'tons';
    let curMfr = 'Airbus';
    let curMode = 'FLEX';
    let isDarkMode = false;
    let isRouteModalOpen = false;

    function getAirDensity(oat, elev_ft, qnh) {
        const T_kelvin = oat + 273.15;
        const P_pa = qnh * 100 * Math.pow(1 - (0.0065 * elev_ft * FT_TO_M / 288.15), 5.255);
        return Math.max(0.1, P_pa / (R_DRY_AIR * T_kelvin));
    }
    function getSurfaceFactors(cond) {
        switch(cond) {
            case 'wet': return { rolling: 0.025, braking: 0.28 };
            case 'contaminated': return { rolling: 0.045, braking: 0.15 };
            default: return { rolling: 0.020, braking: 0.45 };
        }
    }
    function getWindComponents(wdirId, wspdId, rhdgId) {
        const wdir = parseFloat(document.getElementById(wdirId).value) || 0;
        const wspd = parseFloat(document.getElementById(wspdId).value) || 0;
        const rhdg = parseFloat(document.getElementById(rhdgId).value) || 0;
        const diffRad = (wdir - rhdg) * Math.PI / 180;
        return { head: wspd * Math.cos(diffRad), headwind: wspd * Math.cos(diffRad), cross: Math.abs(wspd * Math.sin(diffRad)) };
    }

    function calculateTakeoff(ac, eng, rho, oat) {
        const w_raw = parseFloat(document.getElementById('to_weight').value) || 0;
        const mass_kg = (curUnit === 'lbs' ? w_raw / K_LBS : w_raw) * 1000;
        const tora = parseFloat(document.getElementById('to_tora').value) || 1;
        const slope = parseFloat(document.getElementById('to_slope').value) || 0;
        const flap = ac.toFlaps[document.getElementById('to_flaps').value] || ac.toFlaps[0];
        const rwyCond = document.getElementById('to_rwy_cond').value;
        const { head } = getWindComponents('to_wdir', 'to_wspd', 'to_rwy_hdg');
        const surface = getSurfaceFactors(rwyCond);
        if (mass_kg < 5000) return;
        const vs_ias_ms = Math.sqrt((2 * mass_kg * G_ACCEL) / (1.225 * ac.s_area * flap.cl_max));
        const v2_ias = (vs_ias_ms * 1.15) * MS_TO_KT; 
        const vr_ias = (vs_ias_ms * 1.10) * MS_TO_KT; 
        const v1_ias = vr_ias - (rwyCond === 'dry' ? 2 : 6);
        const tas_conversion = Math.sqrt(1.225 / rho);
        const v_rotate_tas_ms = (vr_ias * tas_conversion - head) * KT_TO_MS;
        let net_thrust = eng.thrust_kn * 1000 * 2.0; 
        const thrust_lapse = (rho / 1.225) * (oat > eng.flat_rating ? (1 - (oat - eng.flat_rating) * 0.01) : 1.0);
        net_thrust *= thrust_lapse;
        if (curMode.includes('FLEX') || curMode.includes('TO-2')) net_thrust *= 0.85;
        else if (curMode.includes('TO-1')) net_thrust *= 0.93;
        let cur_gs = 0, dist = 0, dt = 0.5;
        while (cur_gs < v_rotate_tas_ms && dist < 10000) {
            let drag = 0.5 * rho * Math.pow(cur_gs + head * KT_TO_MS, 2) * ac.s_area * flap.cd0;
            let lift = 0.5 * rho * Math.pow(cur_gs + head * KT_TO_MS, 2) * ac.s_area * flap.cl_to;
            let rolling_friction = Math.max(0, (mass_kg * G_ACCEL - lift) * surface.rolling);
            let accel = (net_thrust - drag - rolling_friction - (mass_kg * G_ACCEL * (slope/100))) / mass_kg;
            cur_gs += accel * dt;
            dist += cur_gs * dt;
        }
        const final_dist = dist * 1.15; 
        const dist_pct = Math.round((final_dist / tora) * 100);
        document.getElementById('res_v1').innerText = Math.round(v1_ias);
        document.getElementById('res_vr').innerText = Math.round(vr_ias);
        document.getElementById('res_v2').innerText = Math.round(v2_ias);
        document.getElementById('res_dist').innerText = Math.round(final_dist) + ' m';
        document.getElementById('to_dist_pct').innerText = dist_pct + '%';
        document.getElementById('to_bar').style.width = Math.min(dist_pct, 100) + '%';
        const warn = document.getElementById('to_warn');
        if (final_dist > tora) { warn.innerText = "‚ö†Ô∏è RUNWAY LIMITED"; warn.classList.remove('hidden'); }
        else { warn.classList.add('hidden'); }
        document.getElementById('res_flex').innerText = curMfr === 'Airbus' ? (curMode === 'FLEX' ? '+52¬∞C' : 'TOGA') : curMode;
        document.getElementById('res_trim').innerText = computeStabTrim(ac, parseFloat(document.getElementById('to_cg').value));
    }

    function calculateLanding(ac) {
        const w_raw = parseFloat(document.getElementById('ld_weight').value) || 0;
        const mass_kg = (curUnit === 'lbs' ? w_raw / K_LBS : w_raw) * 1000;
        const lda = parseFloat(document.getElementById('ld_lda').value) || 1;
        const flap = ac.ldFlaps[document.getElementById('ld_flaps').value] || ac.ldFlaps[0];
        const decel_val = parseFloat(document.getElementById('ld_brake').value) || 2.0;
        const { head } = getWindComponents('ld_wdir', 'ld_wspd', 'ld_rwy_hdg');
        if (mass_kg < 5000) return;
        const vs_land_ias = Math.sqrt((2 * mass_kg * G_ACCEL) / (1.225 * ac.s_area * flap.cl_ref));
        const vref = vs_land_ias * 1.23 * MS_TO_KT;
        const vapp = vref + Math.max(5, Math.min(15, head * 0.5));
        const total_ld = (Math.pow(vref * MS_TO_KT * 0.514, 2) / (2 * decel_val) + 500) * flap.d;
        document.getElementById('res_vref').innerText = Math.round(vref);
        document.getElementById('res_vapp').innerText = Math.round(vapp);
        document.getElementById('res_fld').innerText = Math.round(total_ld) + ' m';
        document.getElementById('res_margin').innerText = Math.round(lda - total_ld) + ' m';
        document.getElementById('ld_bar').style.width = Math.min((total_ld/lda)*100, 100) + '%';
    }

    function calculateFuel(ac) {
        const dist = parseFloat(document.getElementById('fuel_dist').value) || 0;
        const time = dist / ac.cruiseSpeed;
        const trip = (ac.burnRate * time) + ac.climbFuel;
        const block = (trip * 1.05) + (parseFloat(document.getElementById('fuel_taxi').value) || 0) + (parseFloat(document.getElementById('fuel_reserve_input').value) || 0);
        const hrs = Math.floor(time);
        const mins = Math.round((time - hrs) * 60);
        document.getElementById('res_time').innerText = `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        document.getElementById('res_block').innerText = (block * (curUnit === 'lbs' ? K_LBS : 1)).toFixed(1) + (curUnit === 'lbs' ? ' LBS' : ' T');
        document.getElementById('res_trip').innerText = (trip * (curUnit === 'lbs' ? K_LBS : 1)).toFixed(1);
        document.getElementById('res_eff').innerText = (ac.burnRate).toFixed(1) + " T/HR";
    }

    function computeStabTrim(ac, cg) {
        const activeCG = Math.max(15, Math.min(45, cg));
        if (ac.trim_type === 'THS') {
            let val = (30 - activeCG) * 0.18;
            return (val >= 0 ? 'UP ' : 'DN ') + Math.abs(val).toFixed(1);
        } else {
            let val = 6.5 - (activeCG - 15) * 0.22;
            return Math.max(1.0, Math.min(13.0, val)).toFixed(1) + " ANU";
        }
    }

    function toggleRouteFinder() {
        isRouteModalOpen = !isRouteModalOpen;
        document.getElementById('route_finder_modal').style.display = isRouteModalOpen ? 'flex' : 'none';
        document.getElementById('route_knob').classList.toggle('on', isRouteModalOpen);
    }

    function generateRecommendation() {
        const origin = document.getElementById('route_origin').value;
        const typeFilter = document.getElementById('route_type').value;
        const resList = document.getElementById('route_results');
        const empty = document.getElementById('route_empty');
        const acId = document.getElementById('master_ac_type').value;
        const ac = FLEET[acId];
        
        resList.innerHTML = '';
        const allPossible = REAL_ROUTES[origin] || [];
        let filtered = typeFilter === 'ALL' ? allPossible : allPossible.filter(d => d.type === typeFilter);

        if (filtered.length === 0) {
            empty.innerText = "No real destinations found for current filters.";
            empty.classList.remove('hidden');
            resList.classList.add('hidden');
            return;
        }

        filtered.forEach(dest => {
            const timeVal = (dest.dist / ac.cruiseSpeed) + 0.25; 
            const h = Math.floor(timeVal);
            const m = Math.round((timeVal - h) * 60);
            const timeStr = h > 0 ? `${h}h ${m}m` : `${m}m`;

            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/30 rounded-xl border border-gray-100 dark:border-gray-700 cursor-pointer hover:border-blue-500 dark:hover:border-blue-400 transition-colors";
            div.innerHTML = `
                <div>
                    <p class="text-[10px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-tighter">${dest.icao}</p>
                    <p class="text-sm font-bold dark:text-gray-100">${dest.name}</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-black text-emerald-600 dark:text-emerald-400">${dest.dist} NM</p>
                    <p class="text-[9px] font-bold text-amber-600 dark:text-amber-400 uppercase">Est. ${timeStr}</p>
                </div>`;
            div.onclick = () => { document.getElementById('fuel_dist').value = dest.dist; toggleRouteFinder(); calculateAll(); };
            resList.appendChild(div);
        });
        
        resList.classList.remove('hidden'); 
        empty.classList.add('hidden');
    }

    function toggleDarkMode() {
        isDarkMode = !isDarkMode;
        document.body.classList.toggle('dark-mode', isDarkMode);
        document.getElementById('dome_knob').classList.toggle('on', isDarkMode);
    }

    function validateRange(el, min, max) {
        let val = parseFloat(el.value);
        if (val < min) el.value = min; if (val > max) el.value = max;
    }

    function setManufacturer(mfr) {
        curMfr = mfr;
        document.getElementById('tab_airbus').classList.toggle('active', mfr === 'Airbus');
        document.getElementById('tab_boeing').classList.toggle('active', mfr === 'Boeing');
        const sel = document.getElementById('master_ac_type'); sel.innerHTML = '';
        Object.keys(FLEET).filter(k => k.startsWith(mfr === 'Airbus' ? 'A' : 'B')).forEach(k => {
            const opt = document.createElement('option'); opt.value = k; opt.innerText = k; sel.appendChild(opt);
        });
        curMode = mfr === 'Airbus' ? 'FLEX' : 'TO';
        renderThrustUI(); syncAircraft(sel.value);
    }

    function renderThrustUI() {
        const g = document.getElementById('thrust_options_group'); g.innerHTML = '';
        const modes = curMfr === 'Airbus' ? ['FLEX', 'TOGA'] : ['TO', 'TO-1', 'TO-2'];
        modes.forEach(m => {
            const d = document.createElement('div'); d.className = `thrust-option ${curMode === m ? 'active' : ''}`;
            d.innerText = m; d.onclick = () => { curMode = m; renderThrustUI(); calculateAll(); };
            g.appendChild(d);
        });
    }

    function syncAircraft(val) {
        const ac = FLEET[val]; if(!ac) return;
        const es = document.getElementById('master_engine_type'); es.innerHTML = '';
        Object.keys(ac.engines).forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.innerText = k; es.appendChild(opt); });
        document.getElementById('engine_selector_container').classList.toggle('hidden', Object.keys(ac.engines).length < 2);
        const factor = curUnit === 'lbs' ? K_LBS : 1;
        document.getElementById('to_weight').value = (ac.mtow * 0.85 * factor).toFixed(1);
        document.getElementById('ld_weight').value = (ac.mlw * 0.85 * factor).toFixed(1);
        const tf = document.getElementById('to_flaps'); tf.innerHTML = '';
        ac.toFlaps.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.innerText = f.f; tf.appendChild(o); });
        const lf = document.getElementById('ld_flaps'); lf.innerHTML = '';
        ac.ldFlaps.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.innerText = f.f; lf.appendChild(o); });
        const lb = document.getElementById('ld_brake'); lb.innerHTML = '';
        ac.ldBrakes.forEach((b, i) => { const o = document.createElement('option'); o.value = b.decel; o.innerText = b.n; lb.appendChild(o); });
        calculateAll();
    }

    function setMasterUnit(u) {
        if(curUnit === u) return;
        const btnTons = document.getElementById('unit_tons'), btnLbs = document.getElementById('unit_lbs');
        if (u === 'lbs') { btnLbs.classList.add('bg-blue-600', 'text-white'); btnTons.classList.remove('bg-blue-600', 'text-white'); }
        else { btnTons.classList.add('bg-blue-600', 'text-white'); btnLbs.classList.remove('bg-blue-600', 'text-white'); }
        const factor = u === 'lbs' ? K_LBS : (1/K_LBS);
        ['to_weight', 'ld_weight', 'fuel_reserve_input', 'fuel_taxi'].forEach(id => {
            const el = document.getElementById(id); if (el) el.value = (parseFloat(el.value) * factor).toFixed(1);
        });
        document.querySelectorAll('.unit-text').forEach(t => t.innerText = u === 'lbs' ? 'Lbs' : 'Tons');
        curUnit = u; calculateAll();
    }

    function calculateAll() {
        const acId = document.getElementById('master_ac_type').value, ac = FLEET[acId]; if(!ac) return;
        const engId = document.getElementById('master_engine_type').value, eng = ac.engines[engId] || Object.values(ac.engines)[0];
        const to_rho = getAirDensity(parseFloat(document.getElementById('to_env_oat').value), parseFloat(document.getElementById('to_env_elev').value), parseFloat(document.getElementById('to_env_qnh').value));
        calculateTakeoff(ac, eng, to_rho, parseFloat(document.getElementById('to_env_oat').value));
        calculateLanding(ac); calculateFuel(ac);
    }
    window.onload = () => { setManufacturer('Airbus'); };
</script>
</body>
</html>
